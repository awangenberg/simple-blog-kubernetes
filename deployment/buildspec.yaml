version: 0.2

env:
  variables:
    DOCKER_USERNAME: "adaol"
    IMAGE_NAME: "simple-blog-kubernetes"
    IMAGE_TAG: "api-v1.0.0"
  secrets-manager:
    DOCKER_PASSWORD: "docker:password"
    KUBERNETES_CONFIG: "kubernetes_config"

phases:
  install:
    commands:
      - echo install dockerx..
      - mkdir -vp ~/.docker/cli-plugins/
      - curl --silent -L "https://github.com/docker/buildx/releases/download/v0.3.0/buildx-v0.3.0.linux-amd64" > ~/.docker/cli-plugins/docker-buildx
      - chmod a+x ~/.docker/cli-plugins/docker-buildx
    runtime-versions:
      python: 3.8

  pre_build:
    commands:
      - echo Build enviromment `uname -a` `aws --version 2>&1` `python --version`
      - echo Started build at `date`
      - pip install -r requirements.txt
      - echo Logging in to Docker Hub...
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

  build:
    commands:
      - python -m pytest
      - echo Building the Docker image...          
      - docker buildx build --platform=linux/amd64 --push -t $IMAGE_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_NAME:$IMAGE_TAG $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG

  post_build:
    commands:
      - echo pushing docker image...
      - docker push $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
      - echo Restarting api with new image