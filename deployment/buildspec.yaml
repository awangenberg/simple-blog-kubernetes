version: 0.2

env:
  variables:
    DOCKER_USERNAME: "adaol"
    IMAGE_NAME: "simple-blog-kubernetes"
    IMAGE_TAG: "api-$CODEBUILD_BUILD_NUMBER"
  secrets-manager:
    DOCKER_PASSWORD: "docker:password"

phases:
  install:
    runtime-versions:
      python: 3.12

  pre_build:
    commands:
      - export DOCKER_BUILDKIT=1 #enable buildkit for using buildx.
      - docker buildx ls

      - echo Build enviromment `uname -a` `aws --version 2>&1` `python --version`
      - echo Started build at `date`
      - pip install -r requirements.txt
      - echo Logging in to Docker Hub...
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

  build:
    commands:
      - python -m pytest
      - echo Building the Docker image...          
      - docker build -t $IMAGE_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_NAME:$IMAGE_TAG $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG

  post_build:
    commands:
      - echo pushing docker image...
      - docker push $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG
      - echo Restarting api with new image